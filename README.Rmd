---
title: "extendedFamily"
output:
  github_document:
    pandoc_args: --webtex
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```
<!-- badges: start -->
[![CRAN status](https://www.r-pkg.org/badges/version/extendedFamily)](https://cran.r-project.org/package=extendedFamily)
[![R build status](https://github.com/gmcmacran/extendedFamily/workflows/R-CMD-check/badge.svg)](https://github.com/gmcmacran/extendedFamily/actions)
[![Codecov test coverage](https://codecov.io/gh/gmcmacran/extendedFamily/branch/master/graph/badge.svg)](https://codecov.io/gh/gmcmacran/extendedFamily?branch=master)
<!-- badges: end -->

extendedFamily adds new links to R's generalized linear models. These families are drop in additions to the existing families.

## Logit vs Loglog: Mathematical Comparison

The generalized linear model is 

$$ g(Y) = B_0 + B_1X_1 $$

with g being a link function. For the binomial family, the link is usually the logit which makes the model 

$$ ln(\frac{P(Y = 1)}{1 - P(Y = 1)}) = B_0 + B_1X_1 $$ 

Using the loglog link, the model is 

$$ -ln(-ln(P(Y = 1))) = B_0 + B_1X_1 $$

The loglog model assigns a lower probability for X ranging from -5 to 2. The biggest differences are around -1. For X over 2, the models are essentially indistinguishable. 
```{r graphExample, message=FALSE, echo = FALSE}
library(stats)
library(dplyr)
library(extendedFamily)
library(ggplot2)
library(yardstick)


logitLink <- binomial(link = "logit")
loglogLink <- binomialEF(link = "loglog")

temp <- bind_rows(
  tibble(X = seq(-5, 5, .01)) %>%
    mutate(Probability = logitLink$linkinv(X),
           Link = "logit"),
  tibble(X = seq(-5, 5, .01)) %>%
    mutate(Probability = loglogLink$linkinv(X),
           Link = "loglog")
)

ggplot(temp, aes(x = X, y = Probability, colour = Link)) + 
  geom_line() +
  scale_x_continuous(breaks = seq(-5, 5, 1)) + 
  scale_y_continuous(breaks = seq(0, 1, .1))

```


## Logit vs Loglog: Model Performance on Real World Data

The heart data contains info on 4,483 heart attack victims. The goal is to predict if a patient died in the next 48 hours following a myocardial infarction. The low frequency of deaths suggests the loglog link is probably a better than the logit link. 

```{r dataExample, message=FALSE}
data(heart)

heart %>%
  group_by(death) %>%
  summarise(Count = n())
```

Only the family object needs to change to use the loglog link. 

```{r trainModels}
glmLogit <- glm(formula = death ~ anterior + hcabg + kk2 + kk3 + kk4 + age2 + age3 + age4, 
                data = heart, family = binomial(link = "logit"))
glmLoglog <- glm(formula = death ~ anterior + hcabg + kk2 + kk3 + kk4 + age2 + age3 + age4, 
                 data = heart, family = binomialEF(link = "loglog"))
```

Given the same data, AUC is slightly higher for the loglog link.

```{r calcAUC}
predictions <- heart %>%
  select(death) %>%
  mutate(death = factor(death, levels = c("1", "0")),
         logitProb = predict(object = glmLogit, newdata = heart, type = "response"),
         loglogProb = predict(object = glmLoglog, newdata = heart, type = "response"))

roc_auc(data = predictions, truth = death, logitProb)

roc_auc(data = predictions, truth = death, loglogProb)
```
